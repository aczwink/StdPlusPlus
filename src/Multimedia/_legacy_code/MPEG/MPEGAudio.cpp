//Main header
#include "MPEGAudio.h"
//Definitions
#define MPEG1_AUDIO_FRAMEHEADER_MODE_JOINTSTEREO 1
#define MPEG1_AUDIO_FRAMEHEADER_MODE_MONO 3
#define MPEG2_5_AUDIO_FRAMEHEADER_SYNC 0xFFE0 //11bit wide (from left)

//Local functions
static bool CheckFrameHeader(uint32 header)
{
	//Check the sync
	if((header >> 21) != (MPEG2_5_AUDIO_FRAMEHEADER_SYNC >> 5))
		return false;

	//check ID, value 1 is reserved
	if(((header >> 19) & 3) == 1)
		return false;

	//Check the layer, value 0 is reserved
	if(!(header & 0x60000))
		return false;

	//Check the bitrate index... 15 is forbidden
	if(((header >> 12) & 0xF) == 0xF)
		return false;

	//Check the sample rate index... 3 is reserved
	if(((header >> 10) & 3) == 3)
		return false;

	return true;
}

//Global functions
void ApplySynthesisSubbandFilter(const float64(&refBand)[MPEG1_AUDIO_SUBBANDLIMIT], float64(&refV)[1024], float32 *pOutData)
{
	//Algorithm described in 3-A.2
	register uint16 i, j, k;
	register float64 sum;
	register float64 U[512];
	register float64 W[512];

	/*
	Nik values defined in 2.4.3.3
	Precalculated by the formula:
	Nik = cos[(16 + i)(2k + 1)pi/64], for i = 0 to 63, and k = 0 to 31.
	*/
	static const float64 nik[64][32] =
	{
		{0.707106781, -0.707106781, -0.707106781, 0.707106781, 0.707106781, -0.707106781, -0.707106781, 0.707106781, 0.707106781, -0.707106781, -0.707106781, 0.707106781, 0.707106781, -0.707106781, -0.707106781, 0.707106781, 0.707106781, -0.707106781, -0.707106781, 0.707106781, 0.707106781, -0.707106781, -0.707106781, 0.707106781, 0.707106781, -0.707106781, -0.707106781, 0.707106781, 0.707106781, -0.707106781, -0.707106781, 0.707106781},
		{0.671558955, -0.803207531, -0.514102744, 0.903989293, 0.336889853, -0.970031253, -0.146730474, 0.998795456, -0.049067674, -0.989176510, 0.242980180, 0.941544065, -0.427555093, -0.857728610, 0.595699304, 0.740951125, -0.740951125, -0.595699304, 0.857728610, 0.427555093, -0.941544065, -0.242980180, 0.989176510, 0.049067674, -0.998795456, 0.146730474, 0.970031253, -0.336889853, -0.903989293, 0.514102744, 0.803207531, -0.671558955},
		{0.634393284, -0.881921264, -0.290284677, 0.995184727, -0.098017140, -0.956940336, 0.471396737, 0.773010453, -0.773010453, -0.471396737, 0.956940336, 0.098017140, -0.995184727, 0.290284677, 0.881921264, -0.634393284, -0.634393284, 0.881921264, 0.290284677, -0.995184727, 0.098017140, 0.956940336, -0.471396737, -0.773010453, 0.773010453, 0.471396737, -0.956940336, -0.098017140, 0.995184727, -0.290284677, -0.881921264, 0.634393284},
		{0.595699304, -0.941544065, -0.049067674, 0.970031253, -0.514102744, -0.671558955, 0.903989293, 0.146730474, -0.989176510, 0.427555093, 0.740951125, -0.857728610, -0.242980180, 0.998795456, -0.336889853, -0.803207531, 0.803207531, 0.336889853, -0.998795456, 0.242980180, 0.857728610, -0.740951125, -0.427555093, 0.989176510, -0.146730474, -0.903989293, 0.671558955, 0.514102744, -0.970031253, 0.049067674, 0.941544065, -0.595699304},
		{0.555570233, -0.980785280, 0.195090322, 0.831469612, -0.831469612, -0.195090322, 0.980785280, -0.555570233, -0.555570233, 0.980785280, -0.195090322, -0.831469612, 0.831469612, 0.195090322, -0.980785280, 0.555570233, 0.555570233, -0.980785280, 0.195090322, 0.831469612, -0.831469612, -0.195090322, 0.980785280, -0.555570233, -0.555570233, 0.980785280, -0.195090322, -0.831469612, 0.831469612, 0.195090322, -0.980785280, 0.555570233},
		{0.514102744, -0.998795456, 0.427555093, 0.595699304, -0.989176510, 0.336889853, 0.671558955, -0.970031253, 0.242980180, 0.740951125, -0.941544065, 0.146730474, 0.803207531, -0.903989293, 0.049067674, 0.857728610, -0.857728610, -0.049067674, 0.903989293, -0.803207531, -0.146730474, 0.941544065, -0.740951125, -0.242980180, 0.970031253, -0.671558955, -0.336889853, 0.989176510, -0.595699304, -0.427555093, 0.998795456, -0.514102744},
		{0.471396737, -0.995184727, 0.634393284, 0.290284677, -0.956940336, 0.773010453, 0.098017140, -0.881921264, 0.881921264, -0.098017140, -0.773010453, 0.956940336, -0.290284677, -0.634393284, 0.995184727, -0.471396737, -0.471396737, 0.995184727, -0.634393284, -0.290284677, 0.956940336, -0.773010453, -0.098017140, 0.881921264, -0.881921264, 0.098017140, 0.773010453, -0.956940336, 0.290284677, 0.634393284, -0.995184727, 0.471396737},
		{0.427555093, -0.970031253, 0.803207531, -0.049067674, -0.740951125, 0.989176510, -0.514102744, -0.336889853, 0.941544065, -0.857728610, 0.146730474, 0.671558955, -0.998795456, 0.595699304, 0.242980180, -0.903989293, 0.903989293, -0.242980180, -0.595699304, 0.998795456, -0.671558955, -0.146730474, 0.857728610, -0.941544065, 0.336889853, 0.514102744, -0.989176510, 0.740951125, 0.049067674, -0.803207531, 0.970031253, -0.427555093},
		{0.382683432, -0.923879533, 0.923879533, -0.382683432, -0.382683432, 0.923879533, -0.923879533, 0.382683432, 0.382683432, -0.923879533, 0.923879533, -0.382683432, -0.382683432, 0.923879533, -0.923879533, 0.382683432, 0.382683432, -0.923879533, 0.923879533, -0.382683432, -0.382683432, 0.923879533, -0.923879533, 0.382683432, 0.382683432, -0.923879533, 0.923879533, -0.382683432, -0.382683432, 0.923879533, -0.923879533, 0.382683432},
		{0.336889853, -0.857728610, 0.989176510, -0.671558955, 0.049067674, 0.595699304, -0.970031253, 0.903989293, -0.427555093, -0.242980180, 0.803207531, -0.998795456, 0.740951125, -0.146730474, -0.514102744, 0.941544065, -0.941544065, 0.514102744, 0.146730474, -0.740951125, 0.998795456, -0.803207531, 0.242980180, 0.427555093, -0.903989293, 0.970031253, -0.595699304, -0.049067674, 0.671558955, -0.989176510, 0.857728610, -0.336889853},
		{0.290284677, -0.773010453, 0.995184727, -0.881921264, 0.471396737, 0.098017140, -0.634393284, 0.956940336, -0.956940336, 0.634393284, -0.098017140, -0.471396737, 0.881921264, -0.995184727, 0.773010453, -0.290284677, -0.290284677, 0.773010453, -0.995184727, 0.881921264, -0.471396737, -0.098017140, 0.634393284, -0.956940336, 0.956940336, -0.634393284, 0.098017140, 0.471396737, -0.881921264, 0.995184727, -0.773010453, 0.290284677},
		{0.242980180, -0.671558955, 0.941544065, -0.989176510, 0.803207531, -0.427555093, -0.049067674, 0.514102744, -0.857728610, 0.998795456, -0.903989293, 0.595699304, -0.146730474, -0.336889853, 0.740951125, -0.970031253, 0.970031253, -0.740951125, 0.336889853, 0.146730474, -0.595699304, 0.903989293, -0.998795456, 0.857728610, -0.514102744, 0.049067674, 0.427555093, -0.803207531, 0.989176510, -0.941544065, 0.671558955, -0.242980180},
		{0.195090322, -0.555570233, 0.831469612, -0.980785280, 0.980785280, -0.831469612, 0.555570233, -0.195090322, -0.195090322, 0.555570233, -0.831469612, 0.980785280, -0.980785280, 0.831469612, -0.555570233, 0.195090322, 0.195090322, -0.555570233, 0.831469612, -0.980785280, 0.980785280, -0.831469612, 0.555570233, -0.195090322, -0.195090322, 0.555570233, -0.831469612, 0.980785280, -0.980785280, 0.831469612, -0.555570233, 0.195090322},
		{0.146730474, -0.427555093, 0.671558955, -0.857728610, 0.970031253, -0.998795456, 0.941544065, -0.803207531, 0.595699304, -0.336889853, 0.049067674, 0.242980180, -0.514102744, 0.740951125, -0.903989293, 0.989176510, -0.989176510, 0.903989293, -0.740951125, 0.514102744, -0.242980180, -0.049067674, 0.336889853, -0.595699304, 0.803207531, -0.941544065, 0.998795456, -0.970031253, 0.857728610, -0.671558955, 0.427555093, -0.146730474},
		{0.098017140, -0.290284677, 0.471396737, -0.634393284, 0.773010453, -0.881921264, 0.956940336, -0.995184727, 0.995184727, -0.956940336, 0.881921264, -0.773010453, 0.634393284, -0.471396737, 0.290284677, -0.098017140, -0.098017140, 0.290284677, -0.471396737, 0.634393284, -0.773010453, 0.881921264, -0.956940336, 0.995184727, -0.995184727, 0.956940336, -0.881921264, 0.773010453, -0.634393284, 0.471396737, -0.290284677, 0.098017140},
		{0.049067674, -0.146730474, 0.242980180, -0.336889853, 0.427555093, -0.514102744, 0.595699304, -0.671558955, 0.740951125, -0.803207531, 0.857728610, -0.903989293, 0.941544065, -0.970031253, 0.989176510, -0.998795456, 0.998795456, -0.989176510, 0.970031253, -0.941544065, 0.903989293, -0.857728610, 0.803207531, -0.740951125, 0.671558955, -0.595699304, 0.514102744, -0.427555093, 0.336889853, -0.242980180, 0.146730474, -0.049067674},
		{0.000000000, -0.000000000, 0.000000000, -0.000000000, 0.000000000, -0.000000000, -0.000000000, -0.000000000, -0.000000000, -0.000000000, -0.000000000, -0.000000000, -0.000000000, -0.000000000, -0.000000000, -0.000000000, 0.000000000, -0.000000000, 0.000000000, -0.000000000, 0.000000000, -0.000000000, 0.000000000, 0.000000000, 0.000000000, -0.000000000, 0.000000000, 0.000000000, 0.000000000, -0.000000000, 0.000000000, 0.000000000},
		{-0.049067674, 0.146730474, -0.242980180, 0.336889853, -0.427555093, 0.514102744, -0.595699304, 0.671558955, -0.740951125, 0.803207531, -0.857728610, 0.903989293, -0.941544065, 0.970031253, -0.989176510, 0.998795456, -0.998795456, 0.989176510, -0.970031253, 0.941544065, -0.903989293, 0.857728610, -0.803207531, 0.740951125, -0.671558955, 0.595699304, -0.514102744, 0.427555093, -0.336889853, 0.242980180, -0.146730474, 0.049067674},
		{-0.098017140, 0.290284677, -0.471396737, 0.634393284, -0.773010453, 0.881921264, -0.956940336, 0.995184727, -0.995184727, 0.956940336, -0.881921264, 0.773010453, -0.634393284, 0.471396737, -0.290284677, 0.098017140, 0.098017140, -0.290284677, 0.471396737, -0.634393284, 0.773010453, -0.881921264, 0.956940336, -0.995184727, 0.995184727, -0.956940336, 0.881921264, -0.773010453, 0.634393284, -0.471396737, 0.290284677, -0.098017140},
		{-0.146730474, 0.427555093, -0.671558955, 0.857728610, -0.970031253, 0.998795456, -0.941544065, 0.803207531, -0.595699304, 0.336889853, -0.049067674, -0.242980180, 0.514102744, -0.740951125, 0.903989293, -0.989176510, 0.989176510, -0.903989293, 0.740951125, -0.514102744, 0.242980180, 0.049067674, -0.336889853, 0.595699304, -0.803207531, 0.941544065, -0.998795456, 0.970031253, -0.857728610, 0.671558955, -0.427555093, 0.146730474},
		{-0.195090322, 0.555570233, -0.831469612, 0.980785280, -0.980785280, 0.831469612, -0.555570233, 0.195090322, 0.195090322, -0.555570233, 0.831469612, -0.980785280, 0.980785280, -0.831469612, 0.555570233, -0.195090322, -0.195090322, 0.555570233, -0.831469612, 0.980785280, -0.980785280, 0.831469612, -0.555570233, 0.195090322, 0.195090322, -0.555570233, 0.831469612, -0.980785280, 0.980785280, -0.831469612, 0.555570233, -0.195090322},
		{-0.242980180, 0.671558955, -0.941544065, 0.989176510, -0.803207531, 0.427555093, 0.049067674, -0.514102744, 0.857728610, -0.998795456, 0.903989293, -0.595699304, 0.146730474, 0.336889853, -0.740951125, 0.970031253, -0.970031253, 0.740951125, -0.336889853, -0.146730474, 0.595699304, -0.903989293, 0.998795456, -0.857728610, 0.514102744, -0.049067674, -0.427555093, 0.803207531, -0.989176510, 0.941544065, -0.671558955, 0.242980180},
		{-0.290284677, 0.773010453, -0.995184727, 0.881921264, -0.471396737, -0.098017140, 0.634393284, -0.956940336, 0.956940336, -0.634393284, 0.098017140, 0.471396737, -0.881921264, 0.995184727, -0.773010453, 0.290284677, 0.290284677, -0.773010453, 0.995184727, -0.881921264, 0.471396737, 0.098017140, -0.634393284, 0.956940336, -0.956940336, 0.634393284, -0.098017140, -0.471396737, 0.881921264, -0.995184727, 0.773010453, -0.290284677},
		{-0.336889853, 0.857728610, -0.989176510, 0.671558955, -0.049067674, -0.595699304, 0.970031253, -0.903989293, 0.427555093, 0.242980180, -0.803207531, 0.998795456, -0.740951125, 0.146730474, 0.514102744, -0.941544065, 0.941544065, -0.514102744, -0.146730474, 0.740951125, -0.998795456, 0.803207531, -0.242980180, -0.427555093, 0.903989293, -0.970031253, 0.595699304, 0.049067674, -0.671558955, 0.989176510, -0.857728610, 0.336889853},
		{-0.382683432, 0.923879533, -0.923879533, 0.382683432, 0.382683432, -0.923879533, 0.923879533, -0.382683432, -0.382683432, 0.923879533, -0.923879533, 0.382683432, 0.382683432, -0.923879533, 0.923879533, -0.382683432, -0.382683432, 0.923879533, -0.923879533, 0.382683432, 0.382683432, -0.923879533, 0.923879533, -0.382683432, -0.382683432, 0.923879533, -0.923879533, 0.382683432, 0.382683432, -0.923879533, 0.923879533, -0.382683432},
		{-0.427555093, 0.970031253, -0.803207531, 0.049067674, 0.740951125, -0.989176510, 0.514102744, 0.336889853, -0.941544065, 0.857728610, -0.146730474, -0.671558955, 0.998795456, -0.595699304, -0.242980180, 0.903989293, -0.903989293, 0.242980180, 0.595699304, -0.998795456, 0.671558955, 0.146730474, -0.857728610, 0.941544065, -0.336889853, -0.514102744, 0.989176510, -0.740951125, -0.049067674, 0.803207531, -0.970031253, 0.427555093},
		{-0.471396737, 0.995184727, -0.634393284, -0.290284677, 0.956940336, -0.773010453, -0.098017140, 0.881921264, -0.881921264, 0.098017140, 0.773010453, -0.956940336, 0.290284677, 0.634393284, -0.995184727, 0.471396737, 0.471396737, -0.995184727, 0.634393284, 0.290284677, -0.956940336, 0.773010453, 0.098017140, -0.881921264, 0.881921264, -0.098017140, -0.773010453, 0.956940336, -0.290284677, -0.634393284, 0.995184727, -0.471396737},
		{-0.514102744, 0.998795456, -0.427555093, -0.595699304, 0.989176510, -0.336889853, -0.671558955, 0.970031253, -0.242980180, -0.740951125, 0.941544065, -0.146730474, -0.803207531, 0.903989293, -0.049067674, -0.857728610, 0.857728610, 0.049067674, -0.903989293, 0.803207531, 0.146730474, -0.941544065, 0.740951125, 0.242980180, -0.970031253, 0.671558955, 0.336889853, -0.989176510, 0.595699304, 0.427555093, -0.998795456, 0.514102744},
		{-0.555570233, 0.980785280, -0.195090322, -0.831469612, 0.831469612, 0.195090322, -0.980785280, 0.555570233, 0.555570233, -0.980785280, 0.195090322, 0.831469612, -0.831469612, -0.195090322, 0.980785280, -0.555570233, -0.555570233, 0.980785280, -0.195090322, -0.831469612, 0.831469612, 0.195090322, -0.980785280, 0.555570233, 0.555570233, -0.980785280, 0.195090322, 0.831469612, -0.831469612, -0.195090322, 0.980785280, -0.555570233},
		{-0.595699304, 0.941544065, 0.049067674, -0.970031253, 0.514102744, 0.671558955, -0.903989293, -0.146730474, 0.989176510, -0.427555093, -0.740951125, 0.857728610, 0.242980180, -0.998795456, 0.336889853, 0.803207531, -0.803207531, -0.336889853, 0.998795456, -0.242980180, -0.857728610, 0.740951125, 0.427555093, -0.989176510, 0.146730474, 0.903989293, -0.671558955, -0.514102744, 0.970031253, -0.049067674, -0.941544065, 0.595699304},
		{-0.634393284, 0.881921264, 0.290284677, -0.995184727, 0.098017140, 0.956940336, -0.471396737, -0.773010453, 0.773010453, 0.471396737, -0.956940336, -0.098017140, 0.995184727, -0.290284677, -0.881921264, 0.634393284, 0.634393284, -0.881921264, -0.290284677, 0.995184727, -0.098017140, -0.956940336, 0.471396737, 0.773010453, -0.773010453, -0.471396737, 0.956940336, 0.098017140, -0.995184727, 0.290284677, 0.881921264, -0.634393284},
		{-0.671558955, 0.803207531, 0.514102744, -0.903989293, -0.336889853, 0.970031253, 0.146730474, -0.998795456, 0.049067674, 0.989176510, -0.242980180, -0.941544065, 0.427555093, 0.857728610, -0.595699304, -0.740951125, 0.740951125, 0.595699304, -0.857728610, -0.427555093, 0.941544065, 0.242980180, -0.989176510, -0.049067674, 0.998795456, -0.146730474, -0.970031253, 0.336889853, 0.903989293, -0.514102744, -0.803207531, 0.671558955},
		{-0.707106781, 0.707106781, 0.707106781, -0.707106781, -0.707106781, 0.707106781, 0.707106781, -0.707106781, -0.707106781, 0.707106781, 0.707106781, -0.707106781, -0.707106781, 0.707106781, 0.707106781, -0.707106781, -0.707106781, 0.707106781, 0.707106781, -0.707106781, -0.707106781, 0.707106781, 0.707106781, -0.707106781, -0.707106781, 0.707106781, 0.707106781, -0.707106781, -0.707106781, 0.707106781, 0.707106781, -0.707106781},
		{-0.740951125, 0.595699304, 0.857728610, -0.427555093, -0.941544065, 0.242980180, 0.989176510, -0.049067674, -0.998795456, -0.146730474, 0.970031253, 0.336889853, -0.903989293, -0.514102744, 0.803207531, 0.671558955, -0.671558955, -0.803207531, 0.514102744, 0.903989293, -0.336889853, -0.970031253, 0.146730474, 0.998795456, 0.049067674, -0.989176510, -0.242980180, 0.941544065, 0.427555093, -0.857728610, -0.595699304, 0.740951125},
		{-0.773010453, 0.471396737, 0.956940336, -0.098017140, -0.995184727, -0.290284677, 0.881921264, 0.634393284, -0.634393284, -0.881921264, 0.290284677, 0.995184727, 0.098017140, -0.956940336, -0.471396737, 0.773010453, 0.773010453, -0.471396737, -0.956940336, 0.098017140, 0.995184727, 0.290284677, -0.881921264, -0.634393284, 0.634393284, 0.881921264, -0.290284677, -0.995184727, -0.098017140, 0.956940336, 0.471396737, -0.773010453},
		{-0.803207531, 0.336889853, 0.998795456, 0.242980180, -0.857728610, -0.740951125, 0.427555093, 0.989176510, 0.146730474, -0.903989293, -0.671558955, 0.514102744, 0.970031253, 0.049067674, -0.941544065, -0.595699304, 0.595699304, 0.941544065, -0.049067674, -0.970031253, -0.514102744, 0.671558955, 0.903989293, -0.146730474, -0.989176510, -0.427555093, 0.740951125, 0.857728610, -0.242980180, -0.998795456, -0.336889853, 0.803207531},
		{-0.831469612, 0.195090322, 0.980785280, 0.555570233, -0.555570233, -0.980785280, -0.195090322, 0.831469612, 0.831469612, -0.195090322, -0.980785280, -0.555570233, 0.555570233, 0.980785280, 0.195090322, -0.831469612, -0.831469612, 0.195090322, 0.980785280, 0.555570233, -0.555570233, -0.980785280, -0.195090322, 0.831469612, 0.831469612, -0.195090322, -0.980785280, -0.555570233, 0.555570233, 0.980785280, 0.195090322, -0.831469612},
		{-0.857728610, 0.049067674, 0.903989293, 0.803207531, -0.146730474, -0.941544065, -0.740951125, 0.242980180, 0.970031253, 0.671558955, -0.336889853, -0.989176510, -0.595699304, 0.427555093, 0.998795456, 0.514102744, -0.514102744, -0.998795456, -0.427555093, 0.595699304, 0.989176510, 0.336889853, -0.671558955, -0.970031253, -0.242980180, 0.740951125, 0.941544065, 0.146730474, -0.803207531, -0.903989293, -0.049067674, 0.857728610},
		{-0.881921264, -0.098017140, 0.773010453, 0.956940336, 0.290284677, -0.634393284, -0.995184727, -0.471396737, 0.471396737, 0.995184727, 0.634393284, -0.290284677, -0.956940336, -0.773010453, 0.098017140, 0.881921264, 0.881921264, 0.098017140, -0.773010453, -0.956940336, -0.290284677, 0.634393284, 0.995184727, 0.471396737, -0.471396737, -0.995184727, -0.634393284, 0.290284677, 0.956940336, 0.773010453, -0.098017140, -0.881921264},
		{-0.903989293, -0.242980180, 0.595699304, 0.998795456, 0.671558955, -0.146730474, -0.857728610, -0.941544065, -0.336889853, 0.514102744, 0.989176510, 0.740951125, -0.049067674, -0.803207531, -0.970031253, -0.427555093, 0.427555093, 0.970031253, 0.803207531, 0.049067674, -0.740951125, -0.989176510, -0.514102744, 0.336889853, 0.941544065, 0.857728610, 0.146730474, -0.671558955, -0.998795456, -0.595699304, 0.242980180, 0.903989293},
		{-0.923879533, -0.382683432, 0.382683432, 0.923879533, 0.923879533, 0.382683432, -0.382683432, -0.923879533, -0.923879533, -0.382683432, 0.382683432, 0.923879533, 0.923879533, 0.382683432, -0.382683432, -0.923879533, -0.923879533, -0.382683432, 0.382683432, 0.923879533, 0.923879533, 0.382683432, -0.382683432, -0.923879533, -0.923879533, -0.382683432, 0.382683432, 0.923879533, 0.923879533, 0.382683432, -0.382683432, -0.923879533},
		{-0.941544065, -0.514102744, 0.146730474, 0.740951125, 0.998795456, 0.803207531, 0.242980180, -0.427555093, -0.903989293, -0.970031253, -0.595699304, 0.049067674, 0.671558955, 0.989176510, 0.857728610, 0.336889853, -0.336889853, -0.857728610, -0.989176510, -0.671558955, -0.049067674, 0.595699304, 0.970031253, 0.903989293, 0.427555093, -0.242980180, -0.803207531, -0.998795456, -0.740951125, -0.146730474, 0.514102744, 0.941544065},
		{-0.956940336, -0.634393284, -0.098017140, 0.471396737, 0.881921264, 0.995184727, 0.773010453, 0.290284677, -0.290284677, -0.773010453, -0.995184727, -0.881921264, -0.471396737, 0.098017140, 0.634393284, 0.956940336, 0.956940336, 0.634393284, 0.098017140, -0.471396737, -0.881921264, -0.995184727, -0.773010453, -0.290284677, 0.290284677, 0.773010453, 0.995184727, 0.881921264, 0.471396737, -0.098017140, -0.634393284, -0.956940336},
		{-0.970031253, -0.740951125, -0.336889853, 0.146730474, 0.595699304, 0.903989293, 0.998795456, 0.857728610, 0.514102744, 0.049067674, -0.427555093, -0.803207531, -0.989176510, -0.941544065, -0.671558955, -0.242980180, 0.242980180, 0.671558955, 0.941544065, 0.989176510, 0.803207531, 0.427555093, -0.049067674, -0.514102744, -0.857728610, -0.998795456, -0.903989293, -0.595699304, -0.146730474, 0.336889853, 0.740951125, 0.970031253},
		{-0.980785280, -0.831469612, -0.555570233, -0.195090322, 0.195090322, 0.555570233, 0.831469612, 0.980785280, 0.980785280, 0.831469612, 0.555570233, 0.195090322, -0.195090322, -0.555570233, -0.831469612, -0.980785280, -0.980785280, -0.831469612, -0.555570233, -0.195090322, 0.195090322, 0.555570233, 0.831469612, 0.980785280, 0.980785280, 0.831469612, 0.555570233, 0.195090322, -0.195090322, -0.555570233, -0.831469612, -0.980785280},
		{-0.989176510, -0.903989293, -0.740951125, -0.514102744, -0.242980180, 0.049067674, 0.336889853, 0.595699304, 0.803207531, 0.941544065, 0.998795456, 0.970031253, 0.857728610, 0.671558955, 0.427555093, 0.146730474, -0.146730474, -0.427555093, -0.671558955, -0.857728610, -0.970031253, -0.998795456, -0.941544065, -0.803207531, -0.595699304, -0.336889853, -0.049067674, 0.242980180, 0.514102744, 0.740951125, 0.903989293, 0.989176510},
		{-0.995184727, -0.956940336, -0.881921264, -0.773010453, -0.634393284, -0.471396737, -0.290284677, -0.098017140, 0.098017140, 0.290284677, 0.471396737, 0.634393284, 0.773010453, 0.881921264, 0.956940336, 0.995184727, 0.995184727, 0.956940336, 0.881921264, 0.773010453, 0.634393284, 0.471396737, 0.290284677, 0.098017140, -0.098017140, -0.290284677, -0.471396737, -0.634393284, -0.773010453, -0.881921264, -0.956940336, -0.995184727},
		{-0.998795456, -0.989176510, -0.970031253, -0.941544065, -0.903989293, -0.857728610, -0.803207531, -0.740951125, -0.671558955, -0.595699304, -0.514102744, -0.427555093, -0.336889853, -0.242980180, -0.146730474, -0.049067674, 0.049067674, 0.146730474, 0.242980180, 0.336889853, 0.427555093, 0.514102744, 0.595699304, 0.671558955, 0.740951125, 0.803207531, 0.857728610, 0.903989293, 0.941544065, 0.970031253, 0.989176510, 0.998795456},
		{-1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000, -1.000000000},
		{-0.998795456, -0.989176510, -0.970031253, -0.941544065, -0.903989293, -0.857728610, -0.803207531, -0.740951125, -0.671558955, -0.595699304, -0.514102744, -0.427555093, -0.336889853, -0.242980180, -0.146730474, -0.049067674, 0.049067674, 0.146730474, 0.242980180, 0.336889853, 0.427555093, 0.514102744, 0.595699304, 0.671558955, 0.740951125, 0.803207531, 0.857728610, 0.903989293, 0.941544065, 0.970031253, 0.989176510, 0.998795456},
		{-0.995184727, -0.956940336, -0.881921264, -0.773010453, -0.634393284, -0.471396737, -0.290284677, -0.098017140, 0.098017140, 0.290284677, 0.471396737, 0.634393284, 0.773010453, 0.881921264, 0.956940336, 0.995184727, 0.995184727, 0.956940336, 0.881921264, 0.773010453, 0.634393284, 0.471396737, 0.290284677, 0.098017140, -0.098017140, -0.290284677, -0.471396737, -0.634393284, -0.773010453, -0.881921264, -0.956940336, -0.995184727},
		{-0.989176510, -0.903989293, -0.740951125, -0.514102744, -0.242980180, 0.049067674, 0.336889853, 0.595699304, 0.803207531, 0.941544065, 0.998795456, 0.970031253, 0.857728610, 0.671558955, 0.427555093, 0.146730474, -0.146730474, -0.427555093, -0.671558955, -0.857728610, -0.970031253, -0.998795456, -0.941544065, -0.803207531, -0.595699304, -0.336889853, -0.049067674, 0.242980180, 0.514102744, 0.740951125, 0.903989293, 0.989176510},
		{-0.980785280, -0.831469612, -0.555570233, -0.195090322, 0.195090322, 0.555570233, 0.831469612, 0.980785280, 0.980785280, 0.831469612, 0.555570233, 0.195090322, -0.195090322, -0.555570233, -0.831469612, -0.980785280, -0.980785280, -0.831469612, -0.555570233, -0.195090322, 0.195090322, 0.555570233, 0.831469612, 0.980785280, 0.980785280, 0.831469612, 0.555570233, 0.195090322, -0.195090322, -0.555570233, -0.831469612, -0.980785280},
		{-0.970031253, -0.740951125, -0.336889853, 0.146730474, 0.595699304, 0.903989293, 0.998795456, 0.857728610, 0.514102744, 0.049067674, -0.427555093, -0.803207531, -0.989176510, -0.941544065, -0.671558955, -0.242980180, 0.242980180, 0.671558955, 0.941544065, 0.989176510, 0.803207531, 0.427555093, -0.049067674, -0.514102744, -0.857728610, -0.998795456, -0.903989293, -0.595699304, -0.146730474, 0.336889853, 0.740951125, 0.970031253},
		{-0.956940336, -0.634393284, -0.098017140, 0.471396737, 0.881921264, 0.995184727, 0.773010453, 0.290284677, -0.290284677, -0.773010453, -0.995184727, -0.881921264, -0.471396737, 0.098017140, 0.634393284, 0.956940336, 0.956940336, 0.634393284, 0.098017140, -0.471396737, -0.881921264, -0.995184727, -0.773010453, -0.290284677, 0.290284677, 0.773010453, 0.995184727, 0.881921264, 0.471396737, -0.098017140, -0.634393284, -0.956940336},
		{-0.941544065, -0.514102744, 0.146730474, 0.740951125, 0.998795456, 0.803207531, 0.242980180, -0.427555093, -0.903989293, -0.970031253, -0.595699304, 0.049067674, 0.671558955, 0.989176510, 0.857728610, 0.336889853, -0.336889853, -0.857728610, -0.989176510, -0.671558955, -0.049067674, 0.595699304, 0.970031253, 0.903989293, 0.427555093, -0.242980180, -0.803207531, -0.998795456, -0.740951125, -0.146730474, 0.514102744, 0.941544065},
		{-0.923879533, -0.382683432, 0.382683432, 0.923879533, 0.923879533, 0.382683432, -0.382683432, -0.923879533, -0.923879533, -0.382683432, 0.382683432, 0.923879533, 0.923879533, 0.382683432, -0.382683432, -0.923879533, -0.923879533, -0.382683432, 0.382683432, 0.923879533, 0.923879533, 0.382683432, -0.382683432, -0.923879533, -0.923879533, -0.382683432, 0.382683432, 0.923879533, 0.923879533, 0.382683432, -0.382683432, -0.923879533},
		{-0.903989293, -0.242980180, 0.595699304, 0.998795456, 0.671558955, -0.146730474, -0.857728610, -0.941544065, -0.336889853, 0.514102744, 0.989176510, 0.740951125, -0.049067674, -0.803207531, -0.970031253, -0.427555093, 0.427555093, 0.970031253, 0.803207531, 0.049067674, -0.740951125, -0.989176510, -0.514102744, 0.336889853, 0.941544065, 0.857728610, 0.146730474, -0.671558955, -0.998795456, -0.595699304, 0.242980180, 0.903989293},
		{-0.881921264, -0.098017140, 0.773010453, 0.956940336, 0.290284677, -0.634393284, -0.995184727, -0.471396737, 0.471396737, 0.995184727, 0.634393284, -0.290284677, -0.956940336, -0.773010453, 0.098017140, 0.881921264, 0.881921264, 0.098017140, -0.773010453, -0.956940336, -0.290284677, 0.634393284, 0.995184727, 0.471396737, -0.471396737, -0.995184727, -0.634393284, 0.290284677, 0.956940336, 0.773010453, -0.098017140, -0.881921264},
		{-0.857728610, 0.049067674, 0.903989293, 0.803207531, -0.146730474, -0.941544065, -0.740951125, 0.242980180, 0.970031253, 0.671558955, -0.336889853, -0.989176510, -0.595699304, 0.427555093, 0.998795456, 0.514102744, -0.514102744, -0.998795456, -0.427555093, 0.595699304, 0.989176510, 0.336889853, -0.671558955, -0.970031253, -0.242980180, 0.740951125, 0.941544065, 0.146730474, -0.803207531, -0.903989293, -0.049067674, 0.857728610},
		{-0.831469612, 0.195090322, 0.980785280, 0.555570233, -0.555570233, -0.980785280, -0.195090322, 0.831469612, 0.831469612, -0.195090322, -0.980785280, -0.555570233, 0.555570233, 0.980785280, 0.195090322, -0.831469612, -0.831469612, 0.195090322, 0.980785280, 0.555570233, -0.555570233, -0.980785280, -0.195090322, 0.831469612, 0.831469612, -0.195090322, -0.980785280, -0.555570233, 0.555570233, 0.980785280, 0.195090322, -0.831469612},
		{-0.803207531, 0.336889853, 0.998795456, 0.242980180, -0.857728610, -0.740951125, 0.427555093, 0.989176510, 0.146730474, -0.903989293, -0.671558955, 0.514102744, 0.970031253, 0.049067674, -0.941544065, -0.595699304, 0.595699304, 0.941544065, -0.049067674, -0.970031253, -0.514102744, 0.671558955, 0.903989293, -0.146730474, -0.989176510, -0.427555093, 0.740951125, 0.857728610, -0.242980180, -0.998795456, -0.336889853, 0.803207531},
		{-0.773010453, 0.471396737, 0.956940336, -0.098017140, -0.995184727, -0.290284677, 0.881921264, 0.634393284, -0.634393284, -0.881921264, 0.290284677, 0.995184727, 0.098017140, -0.956940336, -0.471396737, 0.773010453, 0.773010453, -0.471396737, -0.956940336, 0.098017140, 0.995184727, 0.290284677, -0.881921264, -0.634393284, 0.634393284, 0.881921264, -0.290284677, -0.995184727, -0.098017140, 0.956940336, 0.471396737, -0.773010453},
		{-0.740951125, 0.595699304, 0.857728610, -0.427555093, -0.941544065, 0.242980180, 0.989176510, -0.049067674, -0.998795456, -0.146730474, 0.970031253, 0.336889853, -0.903989293, -0.514102744, 0.803207531, 0.671558955, -0.671558955, -0.803207531, 0.514102744, 0.903989293, -0.336889853, -0.970031253, 0.146730474, 0.998795456, 0.049067674, -0.989176510, -0.242980180, 0.941544065, 0.427555093, -0.857728610, -0.595699304, 0.740951125}
	};

	//Defined in 3-B.3
	static const float64 D[512] = {0.000000000, -0.000015259, -0.000015259, -0.000015259, -0.000015259, -0.000015259, -0.000015259, -0.000030518, -0.000030518, -0.000030518, -0.000030518, -0.000045776, -0.000045776, -0.000061035, -0.000061035, -0.000076294, -0.000076294, -0.000091553, -0.000106812, -0.000106812, -0.000122070, -0.000137329, -0.000152588, -0.000167847, -0.000198364, -0.000213623, -0.000244141, -0.000259399, -0.000289917, -0.000320435, -0.000366211, -0.000396729, -0.000442505, -0.000473022, -0.000534058, -0.000579834, -0.000625610, -0.000686646, -0.000747681, -0.000808716, -0.000885010, -0.000961304, -0.001037598, -0.001113892, -0.001205444, -0.001296997, -0.001388550, -0.001480103, -0.001586914, -0.001693726, -0.001785278, -0.001907349, -0.002014160, -0.002120972, -0.002243042, -0.002349854, -0.002456665, -0.002578735, -0.002685547, -0.002792358, -0.002899170, -0.002990723, -0.003082275, -0.003173828, 0.003250122, 0.003326416, 0.003387451, 0.003433228, 0.003463745, 0.003479004, 0.003479004, 0.003463745, 0.003417969, 0.003372192, 0.003280640, 0.003173828, 0.003051758, 0.002883911, 0.002700806, 0.002487183, 0.002227783, 0.001937866, 0.001617432, 0.001266479, 0.000869751, 0.000442505, -0.000030518, -0.000549316, -0.001098633, -0.001693726, -0.002334595, -0.003005981, -0.003723145, -0.004486084, -0.005294800, -0.006118774, -0.007003784, -0.007919312, -0.008865356, -0.009841919, -0.010848999, -0.011886597, -0.012939453, -0.014022827, -0.015121460, -0.016235352, -0.017349243, -0.018463135, -0.019577026, -0.020690918, -0.021789551, -0.022857666, -0.023910522, -0.024932861, -0.025909424, -0.026840210, -0.027725220, -0.028533936, -0.029281616, -0.029937744, -0.030532837, -0.031005859, -0.031387329, -0.031661987, -0.031814575, -0.031845093, -0.031738281, -0.031478882, 0.031082153, 0.030517578, 0.029785156, 0.028884888, 0.027801514, 0.026535034, 0.025085449, 0.023422241, 0.021575928, 0.019531250, 0.017257690, 0.014801025, 0.012115479, 0.009231567, 0.006134033, 0.002822876, -0.000686646, -0.004394531, -0.008316040, -0.012420654, -0.016708374, -0.021179199, -0.025817871, -0.030609131, -0.035552979, -0.040634155, -0.045837402, -0.051132202, -0.056533813, -0.061996460, -0.067520142, -0.073059082, -0.078628540, -0.084182739, -0.089706421, -0.095169067, -0.100540161, -0.105819702, -0.110946655, -0.115921021, -0.120697021, -0.125259399, -0.129562378, -0.133590698, -0.137298584, -0.140670776, -0.143676758, -0.146255493, -0.148422241, -0.150115967, -0.151306152, -0.151962280, -0.152069092, -0.151596069, -0.150497437, -0.148773193, -0.146362305, -0.143264771, -0.139450073, -0.134887695, -0.129577637, -0.123474121, -0.116577148, -0.108856201, 0.100311279, 0.090927124, 0.080688477, 0.069595337, 0.057617187, 0.044784546, 0.031082153, 0.016510010, 0.001068115, -0.015228271, -0.032379150, -0.050354004, -0.069168091, -0.088775635, -0.109161377, -0.130310059, -0.152206421, -0.174789429, -0.198059082, -0.221984863, -0.246505737, -0.271591187, -0.297210693, -0.323318481, -0.349868774, -0.376800537, -0.404083252, -0.431655884, -0.459472656, -0.487472534, -0.515609741, -0.543823242, -0.572036743, -0.600219727, -0.628295898, -0.656219482, -0.683914185, -0.711318970, -0.738372803, -0.765029907, -0.791213989, -0.816864014, -0.841949463, -0.866363525, -0.890090942, -0.913055420, -0.935195923, -0.956481934, -0.976852417, -0.996246338, -1.014617920, -1.031936646, -1.048156738, -1.063217163, -1.077117920, -1.089782715, -1.101211548, -1.111373901, -1.120223999, -1.127746582, -1.133926392, -1.138763428, -1.142211914, -1.144287109, 1.144989014, 1.144287109, 1.142211914, 1.138763428, 1.133926392, 1.127746582, 1.120223999, 1.111373901, 1.101211548, 1.089782715, 1.077117920, 1.063217163, 1.048156738, 1.031936646, 1.014617920, 0.996246338, 0.976852417, 0.956481934, 0.935195923, 0.913055420, 0.890090942, 0.866363525, 0.841949463, 0.816864014, 0.791213989, 0.765029907, 0.738372803, 0.711318970, 0.683914185, 0.656219482, 0.628295898, 0.600219727, 0.572036743, 0.543823242, 0.515609741, 0.487472534, 0.459472656, 0.431655884, 0.404083252, 0.376800537, 0.349868774, 0.323318481, 0.297210693, 0.271591187, 0.246505737, 0.221984863, 0.198059082, 0.174789429, 0.152206421, 0.130310059, 0.109161377, 0.088775635, 0.069168091, 0.050354004, 0.032379150, 0.015228271, -0.001068115, -0.016510010, -0.031082153, -0.044784546, -0.057617187, -0.069595337, -0.080688477, -0.090927124, 0.100311279, 0.108856201, 0.116577148, 0.123474121, 0.129577637, 0.134887695, 0.139450073, 0.143264771, 0.146362305, 0.148773193, 0.150497437, 0.151596069, 0.152069092, 0.151962280, 0.151306152, 0.150115967, 0.148422241, 0.146255493, 0.143676758, 0.140670776, 0.137298584, 0.133590698, 0.129562378, 0.125259399, 0.120697021, 0.115921021, 0.110946655, 0.105819702, 0.100540161, 0.095169067, 0.089706421, 0.084182739, 0.078628540, 0.073059082, 0.067520142, 0.061996460, 0.056533813, 0.051132202, 0.045837402, 0.040634155, 0.035552979, 0.030609131, 0.025817871, 0.021179199, 0.016708374, 0.012420654, 0.008316040, 0.004394531, 0.000686646, -0.002822876, -0.006134033, -0.009231567, -0.012115479, -0.014801025, -0.017257690, -0.019531250, -0.021575928, -0.023422241, -0.025085449, -0.026535034, -0.027801514, -0.028884888, -0.029785156, -0.030517578, 0.031082153, 0.031478882, 0.031738281, 0.031845093, 0.031814575, 0.031661987, 0.031387329, 0.031005859, 0.030532837, 0.029937744, 0.029281616, 0.028533936, 0.027725220, 0.026840210, 0.025909424, 0.024932861, 0.023910522, 0.022857666, 0.021789551, 0.020690918, 0.019577026, 0.018463135, 0.017349243, 0.016235352, 0.015121460, 0.014022827, 0.012939453, 0.011886597, 0.010848999, 0.009841919, 0.008865356, 0.007919312, 0.007003784, 0.006118774, 0.005294800, 0.004486084, 0.003723145, 0.003005981, 0.002334595, 0.001693726, 0.001098633, 0.000549316, 0.000030518, -0.000442505, -0.000869751, -0.001266479, -0.001617432, -0.001937866, -0.002227783, -0.002487183, -0.002700806, -0.002883911, -0.003051758, -0.003173828, -0.003280640, -0.003372192, -0.003417969, -0.003463745, -0.003479004, -0.003479004, -0.003463745, -0.003433228, -0.003387451, -0.003326416, 0.003250122, 0.003173828, 0.003082275, 0.002990723, 0.002899170, 0.002792358, 0.002685547, 0.002578735, 0.002456665, 0.002349854, 0.002243042, 0.002120972, 0.002014160, 0.001907349, 0.001785278, 0.001693726, 0.001586914, 0.001480103, 0.001388550, 0.001296997, 0.001205444, 0.001113892, 0.001037598, 0.000961304, 0.000885010, 0.000808716, 0.000747681, 0.000686646, 0.000625610, 0.000579834, 0.000534058, 0.000473022, 0.000442505, 0.000396729, 0.000366211, 0.000320435, 0.000289917, 0.000259399, 0.000244141, 0.000213623, 0.000198364, 0.000167847, 0.000152588, 0.000137329, 0.000122070, 0.000106812, 0.000106812, 0.000091553, 0.000076294, 0.000076294, 0.000061035, 0.000061035, 0.000045776, 0.000045776, 0.000030518, 0.000030518, 0.000030518, 0.000030518, 0.000015259, 0.000015259, 0.000015259, 0.000015259, 0.000015259};

	for(i = 1023; i >= 64; i--)
	{
		refV[i] = refV[i - 64];
	}

	for(i = 0; i <= 63; i++)
	{
		sum = 0;
		for(k = 0; k <= 31; k++)
		{
			sum += nik[i][k] * refBand[k];
		}
		refV[i] = sum;
	}

	for(i = 0; i <= 7; i++)
	{
		for(j = 0; j <= 31; j++)
		{
			U[i * 64 + j] = refV[i * 128 + j];
			U[i * 64 + 32 + j] = refV[i * 128 + 96 + j];
		}
	}

	for(i = 0; i <= 511; i++)
	{
		W[i] = U[i] * D[i];
	}

	for(j = 0; j <= 31; j++)
	{
		sum = 0;
		for(i = 0; i <= 15; i++)
		{
			sum += W[j + 32 * i];
		}

		//*pOutData++ = (float32)sum;
		*pOutData++ = (float32)CLAMP(sum, -1.0, 1.0);
	}
}

bool FindNextFrameHeader(uint32 &refState, ASeekableInputStream &refInput)
{
	while(true)
	{
		if((refState >> 21) == (MPEG2_5_AUDIO_FRAMEHEADER_SYNC >> 5))
		{
			if(CheckFrameHeader(refState))
				return true;
		}
		refState = (refState << 8) | refInput.ReadByte();
		if(refInput.HitEnd())
		{
			refState >>= 8;
			break;
		}
	}
	
	return false;
}

void ParseFrameHeader(uint32 frameHeader, SMPEGAudioFrameHeader &refHeader)
{
	bool padding;
	uint8 bitRateIndex, sampleRateIndex, mode, mode_ext;

	//frame header definition in 2.4.1.3, modified by mpeg2 and mpeg2.5
	
	//ID
	refHeader.isMpeg1 = ((frameHeader >> 19) & 0x3) == 0x3;
	ASSERT(((frameHeader >> 19) & 0x3)); //mpeg2.5 is not implemented!!!
												
	//layer
	refHeader.layer = 4 - ((frameHeader >> 17) & 3);
	ASSERT(refHeader.layer == 2 || refHeader.layer == 3); //only layers 2 and 3 are implemented currently

	//crc
	refHeader.crcFollows = ((frameHeader >> 16) & 1) == 0;
	
	//bitrate
	bitRateIndex = (frameHeader >> 12) & 0xF;
	ASSERT(bitRateIndex && bitRateIndex < 15); //0 is "free format" (needs to be implemented when a sample file is available), 15 is forbidden
	if(refHeader.isMpeg1)
	{
		//In kb/s - defined in 2.4.2.3
		static const uint16 mpeg1BitRateTable[3][15] =
		{
			//Layer 1
			{0/*free format*/, 32, 64, 96, 128, 160, 192, 224, 256, 288, 320, 352, 384, 416, 448},
			//Layer 2
			{0/*free format*/, 32, 48, 56, 64, 80, 96, 112, 128, 160, 192, 224, 256, 320, 384},
			//Layer 3
			{0/*free format*/, 32, 40, 48, 56, 64, 80, 96, 112, 128, 160, 192, 224, 256, 320}
		};

		refHeader.bitRate = mpeg1BitRateTable[refHeader.layer - 1][bitRateIndex] * 1000;
	}
	else
	{
		//In kb/s - defined in 2.4.2.3 (MPEG2)
		static const uint16 mpeg2BitRateTable[2][15] =
		{
			//Layer 1
			{0/*free format*/, 32, 48, 56, 64, 80, 96, 112, 128, 144, 160, 176, 192, 224, 256},
			//Layer 2 & Layer 3
			{0/*free format*/, 8, 16, 24, 32, 40, 48, 56, 64, 80, 96, 112, 128, 144, 160}
		};

		ASSERT(refHeader.layer != 1); //layer 1 is not supported
		
		refHeader.bitRate = mpeg2BitRateTable[refHeader.layer == 1 ? 0 : 1][bitRateIndex] * 1000;
	}

	//sample rate
	//defined in 2.4.2.3 - divide value by 2 if mpeg2, divide value by 4 if mpeg2.5
	static const uint16 mpeg1SampleRateTable[3] = {44100, 48000, 32000};

	sampleRateIndex = (frameHeader >> 10) & 3;
	ASSERT(sampleRateIndex < 3); //3 is reserved
	if(refHeader.isMpeg1)
		refHeader.sampleRate = mpeg1SampleRateTable[sampleRateIndex];
	else
		refHeader.sampleRate = mpeg1SampleRateTable[sampleRateIndex] / 2;

	//padding
	padding = (frameHeader >> 9) & 1;
	
	//channels
	mode = (frameHeader >> 6) & 3;
	ASSERT(mode == 0 || mode == 3 || (mode == 1 && refHeader.layer == 3));

	refHeader.nChannels = (mode == MPEG1_AUDIO_FRAMEHEADER_MODE_MONO) ? 1 : 2;

	//mode extension:
	mode_ext = (frameHeader >> 4) & 3;

	if(mode == MPEG1_AUDIO_FRAMEHEADER_MODE_JOINTSTEREO)
	{
		refHeader.isMS_Stereo = (mode_ext & 0x2) != 0; //true for values 2 or 3
		refHeader.isIntensityStereo = mode_ext & 1; //true for values 1 and 3
	}
	else
	{
		//no joint stereo
		refHeader.isIntensityStereo = false;
		refHeader.isMS_Stereo = false;
	}
	
	//derived values
	refHeader.sideInfoSize = 0;
	if(refHeader.layer == 1)
	{
		NOT_IMPLEMENTED_ERROR;
	}
	else
	{
		refHeader.frameSize = 144 * refHeader.bitRate / refHeader.sampleRate; //formula from 2.4.3.1
		
		if(refHeader.layer == 3)
		{
			if(refHeader.isMpeg1)
			{
				//2.4.3.4 'Start of main data'
				if(refHeader.nChannels == 1)
					refHeader.sideInfoSize = 17;
				else
					refHeader.sideInfoSize = 32;
			}
			else
			{
				refHeader.frameSize /= 2; //mpeg-2 layer 3 has half the granules

				if(refHeader.nChannels == 1)
					refHeader.sideInfoSize = 9;
				else
					refHeader.sideInfoSize = 17;
			}
		}

		refHeader.frameSize += padding;
		refHeader.mainDataSize = refHeader.frameSize;
		refHeader.mainDataSize -= 4; //header size
		refHeader.mainDataSize -= refHeader.sideInfoSize;
	}
	
	/*
	if(refHeader.crcFollows)
		refHeader.payloadSize -= 2; //2 bytes crc
	
	if(refHeader.crcFollows)
		refHeader.encodedFrameSize += 2;
		*/
}